name: tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }} @ ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  cmake-build:
    name: ${{ matrix.platform.name }} ${{ matrix.aes.name }}
    runs-on: ${{ matrix.platform.os }}

    strategy:
      fail-fast: false
      matrix:
        aes:
        - { name: C++ Implementation,      flag: portable}
        - { name: AES-NI - x86_64 - amd64, flag: aesni}
        platform:
        - { name: Windows VS2019, os: windows-2019, extension_name: .exe, }
        - { name: Windows VS2022, os: windows-2022, extension_name: .exe, }
        - { name: MacOS   XCode,  os: macos-latest }
        config:
        - { build_type: Debug }
        - { build_type: Release }

    steps:
    - uses: actions/checkout@v3

    - run: cmake --version

    - name: Configure
      run: cmake -S . -B . -D AES_IMPL=${{matrix.aes.flag}} -DCMAKE_BUILD_TYPE=${{ matrix.config.build_type }}

    - name: Build
      run: cmake --build . --config ${{ matrix.config.build_type }}

    - name: Run Tests (Linux)
      if: runner.os == 'Linux'
      run: ./tests

    - name: Run Tests (Windows)
      if: runner.os == 'Windows'
      run: ${{ matrix.config.build_type }}\tests${{matrix.platform.extension_name}}

  aarch64-gcc:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: update and upgrade env
      run: sudo apt-get update && sudo apt-get upgrade

    - name: Install essentials
      run: sudo apt-get install qemu-user qemu-user-static gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu binutils-aarch64-linux-gnu-dbg build-essential

    - name: create test output directory
      run: mkdir bin

    - name: Test - portable C++ code
      run: make test CXX=aarch64-linux-gnu-g++ LINK=static TYPE=debug VERSION=portable

    - name: Test - aarch64/armv8 - ARM-NEON-AES
      run: make test CXX=aarch64-linux-gnu-g++ LINK=static TYPE=debug VERSION=neon

  clang:

    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, windows-2019, macos-latest]
    
    steps:
    - uses: actions/checkout@v3

    - name: create test output directory
      run: mkdir bin

    - name: Test - portable C++ code
      run: make test CXX=clang++ TYPE=debug VERSION=portable

    - name: Test - x86-64 - AES-NI
      run: make test CXX=clang++ TYPE=debug VERSION=aesni

  gcc:

    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, windows-2019, macos-latest]
    
    steps:
    - uses: actions/checkout@v3

    - name: create test output directory
      run: mkdir bin

    - name: Test - portable C++ code
      run: make test CXX=g++ TYPE=debug VERSION=portable

    - name: Test - x86-64 - AES-NI
      run: make test CXX=g++ TYPE=debug VERSION=aesni